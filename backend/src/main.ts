import { NestFactory } from '@nestjs/core';
import { ValidationPipe } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';
import helmet from 'helmet';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  const configService = app.get(ConfigService);

  // Security
  app.use(helmet());

  // CORS
  const allowedOrigins = configService.get<string>('ALLOWED_ORIGINS')?.split(',') || [];
  const isDevelopment = configService.get<string>('NODE_ENV') === 'development';
  
  app.enableCors({
    origin: isDevelopment ? true : allowedOrigins, // Allow all origins in development
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization', 'Accept-Language'],
  });

  // Global prefix
  const apiPrefix = configService.get<string>('API_PREFIX') || 'api/v1';
  app.setGlobalPrefix(apiPrefix);

  // Validation
  app.useGlobalPipes(
    new ValidationPipe({
      whitelist: true,
      forbidNonWhitelisted: true,
      transform: true,
      transformOptions: {
        enableImplicitConversion: true,
      },
    }),
  );

  // Swagger API Documentation
  const config = new DocumentBuilder()
    .setTitle('Sahhafood API')
    .setDescription('Food Delivery Backend API - ØªÙˆØµÙŠÙ„ Ø§Ù„Ø·Ø¹Ø§Ù…')
    .setVersion('1.0')
    .addBearerAuth(
      {
        type: 'http',
        scheme: 'bearer',
        bearerFormat: 'JWT',
        name: 'JWT',
        description: 'Enter JWT token',
        in: 'header',
      },
      'JWT-auth',
    )
    .addTag('auth', 'Authentication endpoints')
    .addTag('users', 'User management')
    .addTag('restaurants', 'Restaurant management')
    .addTag('foods', 'Food items')
    .addTag('orders', 'Order management')
    .addTag('cart', 'Shopping cart')
    .addTag('addresses', 'User addresses')
    .addTag('ratings', 'Ratings and reviews')
    .addTag('vouchers', 'Promotions and vouchers')
    .addTag('admin', 'Admin panel')
    .build();

  const document = SwaggerModule.createDocument(app, config);
  SwaggerModule.setup('docs', app, document);

  // Start server
  const port = configService.get<number>('PORT') || 3000;
  await app.listen(port);

  console.log(`ðŸš€ Application is running on: http://localhost:${port}/${apiPrefix}`);
  console.log(`ðŸ“š API Documentation: http://localhost:${port}/docs`);
}

bootstrap();
